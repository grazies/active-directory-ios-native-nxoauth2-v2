<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=640">

    <link rel="stylesheet" href="stylesheets/core.css" media="screen">
    <link rel="stylesheet" href="stylesheets/mobile.css" media="handheld, only screen and (max-device-width:640px)">
    <link rel="stylesheet" href="stylesheets/github-light.css">

    <script type="text/javascript" src="javascripts/modernizr.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script type="text/javascript" src="javascripts/headsmart.min.js"></script>
    <script type="text/javascript">
      $(document).ready(function () {
        $('#main_content').headsmart()
      })
    </script>
    <title>Active-directory-ios-native-nxoauth2-v2 by grazies</title>
  </head>

  <body>
    <a id="forkme_banner" href="https://github.com/grazies/active-directory-ios-native-nxoauth2-v2">View on GitHub</a>
    <div class="shell">

      <header>
        <span class="ribbon-outer">
          <span class="ribbon-inner">
            <h1>Active-directory-ios-native-nxoauth2-v2</h1>
            <h2>Demonstrates how you can use a third party library like nxoauth2 to build an iOS application that authenticates Microsoft identity users to our new v2 (converged) identity service and calls a web API using OAuth 2.0 access tokens.</h2>
          </span>
          <span class="left-tail"></span>
          <span class="right-tail"></span>
        </span>
      </header>

      <section id="downloads">
        <span class="inner">
          <a href="https://github.com/grazies/active-directory-ios-native-nxoauth2-v2/zipball/master" class="zip"><em>download</em> .ZIP</a><a href="https://github.com/grazies/active-directory-ios-native-nxoauth2-v2/tarball/master" class="tgz"><em>download</em> .TGZ</a>
        </span>
      </section>


      <span class="banner-fix"></span>


      <section id="main_content">
        <p><strong>NOTE regarding iOS 9:</strong></p>

<p>Apple has released iOS 9 which includes support for App Transport Security (ATS). ATS restricts apps from accessing the internet unless they meet several security requirements incuding TLS 1.2 and SHA-256. While Microsoft's APIs support these standards some third party APIs and content delivery networks we use have yet to be upgraded. This means that any app that relies on Azure Active Directory or Microsoft Accounts will fail when compiled with iOS 9. For now our recommendation is to disable ATS, which reverts to iOS 8 functionality. Please refer to this <a href="https://developer.apple.com/library/prerelease/ios/technotes/App-Transport-Security-Technote/">technote from Apple</a> for more informtaion.</p>

<hr>

<p>Azure AD provides the Active Directory Authentication Library, or ADAL, for iOS clients that need to access protected resources.  ADAL’s sole purpose in life is to make it easy for your app to get access tokens.  To demonstrate just how easy it is, here we’ll build a Objective C To-Do List application that:</p>

<ul>
<li>  Gets access tokens for calling the Azure AD Graph API using the <a href="https://msdn.microsoft.com/library/azure/dn645545.aspx">OAuth 2.0 authentication protocol</a>.</li>
<li>  Searches a directory for users with a given alias.</li>
</ul>

<p>To build the complete working application, you’ll need to:</p>

<ol>
<li>Register your application with Azure AD.</li>
<li>Install &amp; Configure ADAL.</li>
<li>Use ADAL to get tokens from Azure AD.</li>
</ol>

<p>To get started, <a href="https://github.com/AzureADQuickStarts/NativeClient-iOS/archive/complete.zip">download the completed sample</a>.  You'll also need an Azure AD tenant in which you can create users and register an application.  If you don't already have a tenant, <a href="active-directory-howto-tenant.md">learn how to get one</a>.</p>

<h2>
<a id="1-determine-what-your-redirect-uri-will-be-for-ios" class="anchor" href="#1-determine-what-your-redirect-uri-will-be-for-ios" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a><em>1. Determine what your Redirect URI will be for iOS</em>
</h2>

<p>In order to securely launch your applications in certain SSO scenarios we require that you create a <strong>Redirect URI</strong> in a particular format. A Redirect URI is used to ensure that the tokens return to the correct application that asked for them.</p>

<p>The iOS format for a Redirect URI is:</p>

<pre><code>&lt;app-scheme&gt;://&lt;bundle-id&gt;
</code></pre>

<ul>
<li>  <strong>aap-scheme</strong> - This is registered in your XCode project. It is how other applications can call you. You can find this under Info.plist -&gt; URL types -&gt; URL Identifier. You should create one if you don't already have one or more configured.</li>
<li>  <strong>bundle-id</strong> - This is the Bundle Identifier found under "identity" un your project settings in XCode.</li>
</ul>

<p>An example for this QuickStart code would be: <strong><em>msquickstart://com.microsoft.azureactivedirectory.samples.graph.QuickStart</em></strong></p>

<h2>
<a id="2-register-the-directorysearcher-application" class="anchor" href="#2-register-the-directorysearcher-application" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a><em>2. Register the DirectorySearcher Application</em>
</h2>

<p>To enable your app to get tokens, you'll first need to register it in your Azure AD tenant and grant it permission to access the Azure AD Graph API:</p>

<ol>
<li>Sign in to the <a href="https://portal.azure.com">Azure portal</a>.</li>
<li>On the top bar, click on your account and under the <strong>Directory</strong> list, choose the Active Directory tenant where you wish to register your application.</li>
<li>Click on <strong>More Services</strong> in the left hand nav, and choose <strong>Azure Active Directory</strong>.</li>
<li>Click on <strong>App registrations</strong> and choose <strong>Add</strong>.</li>
<li>Enter a friendly name for the application, for example 'DirectorySearcher' and select 'Native' as the Application Type. The <strong>Redirect Uri</strong> is a scheme and string combination that Azure AD will use to return token responses.  Enter a value specific to your application based on the information above. Click on <strong>Create</strong> to create the application.</li>
<li>While still in the Azure portal, choose your application, click on <strong>Settings</strong> and choose <strong>Properties</strong>.</li>
<li>Find the Application ID value and copy it to the clipboard.</li>
<li>Configure Permissions for your application - in the Settings menu, choose the 'Required permissions' section, click on <strong>Add</strong>, then <strong>Select an API</strong>, and select 'Microsoft Graph' (this is the Graph API). Then, click on  <strong>Select Permissions</strong> and select 'Read Directory Data'.</li>
</ol>

<h2>
<a id="3-install--configure-adal" class="anchor" href="#3-install--configure-adal" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a><em>3. Install &amp; Configure ADAL</em>
</h2>

<p>Now that you have an application in Azure AD, you can install ADAL and write your identity-related code.  In order for ADAL to be able to communicate with Azure AD, you need to provide it with some information about your app registration.</p>

<ul>
<li>  Begin by adding ADAL to the DirectorySearcher project using Cocapods.</li>
</ul>

<pre><code>$ vi Podfile
</code></pre>

<p>Add the following to this podfile:</p>

<pre><code>source 'https://github.com/CocoaPods/Specs.git'
link_with ['QuickStart']
xcodeproj 'QuickStart'

pod 'ADALiOS'
</code></pre>

<p>Now load the podfile using cocoapods. This will create a new XCode Workspace you will load.</p>

<pre><code>$ pod install
...
$ open QuickStart.xcworkspace
</code></pre>

<ul>
<li>  In the QuickStart project, open the plist file <code>settings.plist</code>.  Replace the values of the elements in the section to reflect the values you input into the Azure Portal.  Your code will reference these values whenever it uses ADAL.

<ul>
<li>  The <code>tenant</code> is the domain of your Azure AD tenant, e.g. contoso.onmicrosoft.com</li>
<li>  The <code>clientId</code> is the clientId of your application you copied from the portal.</li>
<li>  The <code>redirectUri</code> is the redirect url you registered in the portal.</li>
</ul>
</li>
</ul>

<h2>
<a id="4--use-adal-to-get-tokens-from-aad" class="anchor" href="#4--use-adal-to-get-tokens-from-aad" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a><em>4.  Use ADAL to Get Tokens from AAD</em>
</h2>

<p>The basic principle behind ADAL is that whenever your app needs an access token, it simply calls a completionBlock <code>+(void) getToken :</code>, and ADAL does the rest.  </p>

<ul>
<li>  In the <code>QuickStart</code> project, open <code>GraphAPICaller.m</code> and locate the <code>// TODO: getToken for generic Web API flows. Returns a token with no additional parameters provided.</code> comment near the top.  This is where you pass ADAL the coordinates through a CompletionBlock to communicate with Azure AD and tell it how to cache tokens.</li>
</ul>

<div class="highlight highlight-source-objc"><pre>+(<span class="pl-k">void</span>) getToken : (<span class="pl-c1">BOOL</span>) clearCache
           parent:(UIViewController*) parent
completionHandler:(<span class="pl-k">void</span> (^) (<span class="pl-c1">NSString</span>*, <span class="pl-c1">NSError</span>*))completionBlock;
{
    AppData* data = [AppData <span class="pl-c1">getInstance</span>];
    <span class="pl-k">if</span>(data.<span class="pl-smi">userItem</span>){
        <span class="pl-c1">completionBlock</span>(data.<span class="pl-smi">userItem</span>.<span class="pl-smi">accessToken</span>, <span class="pl-c1">nil</span>);
        <span class="pl-k">return</span>;
    }

    ADAuthenticationError *error;
    authContext = [ADAuthenticationContext <span class="pl-c1">authenticationContextWithAuthority:</span>data.authority <span class="pl-c1">error:</span>&amp;error];
    authContext.<span class="pl-smi">parentController</span> = parent;
    <span class="pl-c1">NSURL</span> *redirectUri = [[<span class="pl-c1">NSURL</span> <span class="pl-c1">alloc</span>]initWithString:data.redirectUriString];

    [ADAuthenticationSettings <span class="pl-c1">sharedInstance</span>].<span class="pl-smi">enableFullScreen</span> = <span class="pl-c1">YES</span>;
    [authContext <span class="pl-c1">acquireTokenWithResource:</span>data.resourceId
                                 <span class="pl-c1">clientId:</span>data.clientId
                              <span class="pl-c1">redirectUri:</span>redirectUri
                           <span class="pl-c1">promptBehavior:</span>AD_PROMPT_AUTO
                                   <span class="pl-c1">userId:</span>data.userItem.userInformation.userId
                     <span class="pl-c1">extraQueryParameters:</span> <span class="pl-s"><span class="pl-pds">@"</span>nux=1<span class="pl-pds">"</span></span> <span class="pl-c">// if this strikes you as strange it was legacy to display the correct mobile UX. You most likely won't need it in your code.</span>
                          <span class="pl-c1">completionBlock:</span>^(ADAuthenticationResult *result) {

                              <span class="pl-k">if</span> (result.<span class="pl-smi">status</span> != AD_SUCCEEDED)
                              {
                                  <span class="pl-c1">completionBlock</span>(<span class="pl-c1">nil</span>, result.<span class="pl-smi">error</span>);
                              }
                              <span class="pl-k">else</span>
                              {
                                  data.<span class="pl-smi">userItem</span> = result.<span class="pl-smi">tokenCacheStoreItem</span>;
                                  <span class="pl-c1">completionBlock</span>(result.<span class="pl-smi">tokenCacheStoreItem</span>.<span class="pl-smi">accessToken</span>, <span class="pl-c1">nil</span>);
                              }
                          }];
}
</pre></div>

<ul>
<li>Now we need to use this token to search for users in the graph. Find the <code>// TODO: implement SearchUsersList</code> commentThis method makes a GET request to the Azure AD Graph API to query for users whose UPN begins with the given search term.  But in order to query the Graph API, you need to include an access_token in the <code>Authorization</code> header of the request - this is where ADAL comes in.</li>
</ul>

<div class="highlight highlight-source-objc"><pre>+(<span class="pl-k">void</span>) searchUserList:(<span class="pl-c1">NSString</span>*)searchString
                parent:(UIViewController*) parent
       completionBlock:(<span class="pl-k">void</span> (^) (<span class="pl-c1">NSMutableArray</span>* Users, <span class="pl-c1">NSError</span>* error)) completionBlock
{
    <span class="pl-k">if</span> (!loadedApplicationSettings)
    {
        [<span class="pl-v">self</span> <span class="pl-c1">readApplicationSettings</span>];
    }

    AppData* data = [AppData <span class="pl-c1">getInstance</span>];

    <span class="pl-c1">NSString</span> *graphURL = [<span class="pl-c1">NSString</span> <span class="pl-c1">stringWithFormat:</span><span class="pl-s"><span class="pl-pds">@"</span><span class="pl-c1">%@%@</span>/users?api-version=<span class="pl-c1">%@</span>&amp;$filter=startswith(userPrincipalName, '<span class="pl-c1">%@</span>')<span class="pl-pds">"</span></span>, data.taskWebApiUrlString, data.tenant, data.apiversion, searchString];


    [<span class="pl-v">self</span> <span class="pl-c1">craftRequest:</span>[<span class="pl-v">self</span>.class <span class="pl-c1">trimString:</span>graphURL]
                <span class="pl-c1">parent:</span>parent
     <span class="pl-c1">completionHandler:</span>^(<span class="pl-c1">NSMutableURLRequest</span> *request, <span class="pl-c1">NSError</span> *error) {

         <span class="pl-k">if</span> (error != <span class="pl-c1">nil</span>)
         {
             <span class="pl-c1">completionBlock</span>(<span class="pl-c1">nil</span>, error);
         }
         <span class="pl-k">else</span>
         {

             <span class="pl-c1">NSOperationQueue</span> *queue = [[<span class="pl-c1">NSOperationQueue</span> <span class="pl-c1">alloc</span>]init];

             [<span class="pl-c1">NSURLConnection</span> <span class="pl-c1">sendAsynchronousRequest:</span>request <span class="pl-c1">queue:</span>queue <span class="pl-c1">completionHandler:</span>^(<span class="pl-c1">NSURLResponse</span> *response, <span class="pl-c1">NSData</span> *data, <span class="pl-c1">NSError</span> *error) {

                 <span class="pl-k">if</span> (error == <span class="pl-c1">nil</span> &amp;&amp; data != <span class="pl-c1">nil</span>){

                     <span class="pl-c1">NSDictionary</span> *dataReturned = [<span class="pl-c1">NSJSONSerialization</span> <span class="pl-c1">JSONObjectWithData:</span>data <span class="pl-c1">options:</span><span class="pl-c1">0</span> <span class="pl-c1">error:</span><span class="pl-c1">nil</span>];

                     <span class="pl-c">// We can grab the top most JSON node to get our graph data.</span>
                     <span class="pl-c1">NSArray</span> *graphDataArray = [dataReturned <span class="pl-c1">objectForKey:</span><span class="pl-s"><span class="pl-pds">@"</span>value<span class="pl-pds">"</span></span>];

                     <span class="pl-c">// Don't be thrown off by the key name being "value". It really is the name of the</span>
                     <span class="pl-c">// first node. :-)</span>

                     <span class="pl-c">//each object is a key value pair</span>
                     <span class="pl-c1">NSDictionary</span> *keyValuePairs;
                     <span class="pl-c1">NSMutableArray</span>* Users = [[<span class="pl-c1">NSMutableArray</span> <span class="pl-c1">alloc</span>]init];

                     <span class="pl-k">for</span>(<span class="pl-k">int</span> i =<span class="pl-c1">0</span>; i &lt; graphDataArray.<span class="pl-smi">count</span>; i++)
                     {
                         keyValuePairs = [graphDataArray <span class="pl-c1">objectAtIndex:</span>i];

                         User *s = [[User <span class="pl-c1">alloc</span>]init];
                         s.<span class="pl-smi">upn</span> = [keyValuePairs <span class="pl-c1">valueForKey:</span><span class="pl-s"><span class="pl-pds">@"</span>userPrincipalName<span class="pl-pds">"</span></span>];
                         s.<span class="pl-smi">name</span> =[keyValuePairs <span class="pl-c1">valueForKey:</span><span class="pl-s"><span class="pl-pds">@"</span>givenName<span class="pl-pds">"</span></span>];

                         [Users <span class="pl-c1">addObject:</span>s];
                     }

                     <span class="pl-c1">completionBlock</span>(Users, <span class="pl-c1">nil</span>);
                 }
                 <span class="pl-k">else</span>
                 {
                     <span class="pl-c1">completionBlock</span>(<span class="pl-c1">nil</span>, error);
                 }

             }];
         }
     }];

}
</pre></div>

<ul>
<li>When your app requests a token by calling <code>getToken(...)</code>, ADAL will attempt to return a token without asking the user for credentials.  If ADAL determines that the user needs to sign in to get a token, it will display a login dialog, collect the user's credentials, and return a token upon successful authentication.  If ADAL is unable to return a token for any reason, it will throw an <code>AdalException</code>.</li>
<li>Notice that the <code>AuthenticationResult</code> object contains a <code>tokenCacheStoreItem</code> object that can be used to collect information your app may need.  In the QuickStart, <code>tokenCacheStoreItem</code> is used to determine if authenitcation has already occurred.</li>
</ul>

<h2>
<a id="step-5-build-and-run-the-application" class="anchor" href="#step-5-build-and-run-the-application" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Step 5: Build and Run the application</h2>

<p>Congratulations! You now have a working iOS application that has the ability to authenticate users, securely call Web APIs using OAuth 2.0, and get basic information about the user.  If you haven't already, now is the time to populate your tenant with some users.  Run your QuickStart app, and sign in with one of those users.  Search for other users based on their UPN.  Close the app, and re-run it.  Notice how the user's session remains intact.</p>

<p>ADAL makes it easy to incorporate all of these common identity features into your application.  It takes care of all the dirty work for you - cache management, OAuth protocol support, presenting the user with a login UI, refreshing expired tokens, and more.  All you really need to know is a single API call, <code>getToken</code>.</p>

<p>For reference, the completed sample (without your configuration values) is provided <a href="https://github.com/AzureADQuickStarts/NativeClient-iOS/archive/complete.zip">here</a>.  You can now move on to additional scenarios.  You may want to try:</p>

<p><a href="active-directory-devquickstarts-webapi-nodejst.md">Secure a Node.JS Web API with Azure AD &gt;&gt;</a></p>

<p>For additional resources, check out:</p>

<ul>
<li><a href="https://github.com/AzureAdSamples">AzureADSamples on GitHub &gt;&gt;</a></li>
<li><a href="https://cloudidentity.com">CloudIdentity.com &gt;&gt;</a></li>
<li>Azure AD documentation on <a href="http://azure.microsoft.com/documentation/services/active-directory/">Azure.com &gt;&gt;</a>
</li>
</ul>
      </section>

      <footer>
        <span class="ribbon-outer">
          <span class="ribbon-inner">
            <p>this project by <a href="https://github.com/grazies">grazies</a> can be found on <a href="https://github.com/grazies/active-directory-ios-native-nxoauth2-v2">GitHub</a></p>
          </span>
          <span class="left-tail"></span>
          <span class="right-tail"></span>
        </span>
        <p>Generated with <a href="https://pages.github.com">GitHub Pages</a> using Merlot</p>
        <span class="octocat"></span>
      </footer>

    </div>

    
  </body>
</html>
